/* 掛抎厙桴ㄩhttp://www.androidbks.com
* 秷豎iOS諺斻ㄩhttp://www.51work6.com
* 秷豎iOS諺斻婓盄諺斻ㄩhttp://v.51work6.com
* 秷豎iOS諺斻陔檢峚痔ㄩhttp://weibo.com/u/3215753973
* 釬氪峚痔ㄩhttp://weibo.com/516inc
* 夥源csdn痔諦ㄩhttp://blog.csdn.net/tonny_guan
* QQㄩ1575716557 蚘眊ㄩjylong06@163.com
*/ 

package com.god.holywar;


import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.DefaultHttpClient;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.app.AlertDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.graphics.BitmapFactory;
import android.os.Handler;
import android.os.Message;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.MotionEvent;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ListView;
import android.widget.SimpleAdapter;
import android.widget.TextView;
import android.widget.Toast;

import com.work6.designpattern.Scene;
import com.work6.designpattern.Spirit;

/**
 * 茼蚚笢腔蚔牁部劓濬
 * 
 * @author 壽陲汔
 * 
 */
public class HolyWarScene extends Scene {

	private final static String TAG = "HolyWarScene";
	private int[] spiritsImage;
	private String[] spiritsName;

	/** 諉彶秏洘 */
	private Handler handler = new MyHandler();

	/** 盄最傖埜曹講 */
	private ActivityThread thread;

	public HolyWarScene(Context context, String[] spirits) {
		super(context);

		// 掖劓 場宎趙
		Spirit bgSpirit = new Spirit(BitmapFactory.decodeResource(
				getResources(), R.drawable.castle_bg), 0, 0, 0, 0, null);
		addSpirit(bgSpirit);

		this.spiritsName = spirits;
		this.spiritsImage = AppUtil.getBuidingImgId(this.spiritsName);
		// 1#華輸
		Spirit spirit1 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[0]), 225, 26, 0, 0,
				"onTouchEvent1");
		addSpirit(spirit1);

		// 2#華輸
		Spirit spirit2 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[1]), 300, 30, 0, 0,
				"onTouchEvent2");
		addSpirit(spirit2);

		// 3#華輸
		Spirit spirit3 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[2]), 379, 103, 0, 0,
				"onTouchEvent3");
		addSpirit(spirit3);

		// 4#華輸
		Spirit spirit4 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[3]), 149, 45, 0, 0,
				"onTouchEvent4");
		addSpirit(spirit4);

		// 5#華輸
		Spirit spirit5 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[4]), 91, 80, 0, 0, "onTouchEvent5");
		addSpirit(spirit5);

		// 6#華輸
		Spirit spirit6 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[5]), 40, 120, 0, 0,
				"onTouchEvent6");
		addSpirit(spirit6);

		// 7#華輸
		Spirit spirit7 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[6]), 212, 85, 0, 0,
				"onTouchEvent7");
		addSpirit(spirit7);

		// 8#華輸
		Spirit spirit8 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[7]), 163, 128, 0, 0,
				"onTouchEvent8");
		addSpirit(spirit8);

		// 9#華輸
		Spirit spirit9 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[8]), 100, 150, 0, 0,
				"onTouchEvent9");
		addSpirit(spirit9);

		// 10#華輸
		Spirit spirit10 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[9]), 300, 130, 0, 0,
				"onTouchEvent10");
		addSpirit(spirit10);

		// 11#華輸
		Spirit spirit11 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[10]), 246, 175, 0, 0,
				"onTouchEvent11");
		addSpirit(spirit11);

		// 12#華輸
		Spirit spirit12 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[11]), 180, 220, 0, 0,
				"onTouchEvent12");
		addSpirit(spirit12);

		// 13#華輸
		Spirit spirit13 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[12]), 364, 171, 0, 0,
				"onTouchEvent13");
		addSpirit(spirit13);

		// 14#華輸
		Spirit spirit14 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[13]), 304, 220, 0, 0,
				"onTouchEvent14");
		addSpirit(spirit14);

		// 15#華輸
		Spirit spirit15 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[14]), 240, 265, 0, 0,
				"onTouchEvent15");
		addSpirit(spirit15);

		// 16#華輸
		Spirit spirit16 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[15]), 400, 230, 0, 0,
				"onTouchEvent16");
		addSpirit(spirit16);

		// 17#華輸
		Spirit spirit17 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[16]), 45, 10, 0, 0,
				"onTouchEvent17");
		addSpirit(spirit17);

		// 18#華輸
		Spirit spirit18 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[17]), 49, 178, 0, 0,
				"onTouchEvent18");
		addSpirit(spirit18);

		// 19#華輸
		Spirit spirit19 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[18]), 100, 215, 0, 0,
				"onTouchEvent19");
		addSpirit(spirit19);

		// 20#華輸
		Spirit spirit20 = new Spirit(BitmapFactory.decodeResource(
				getResources(), spiritsImage[19]), 196, 278, 0, 0,
				"onTouchEvent20");
		addSpirit(spirit20);

	}

	/**
	 * 揖類1#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent1(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類1#華輸 " + sp.getCoordinates());
		handleSoilid(1);
	}

	/**
	 * 揖類2#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent2(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類2#華輸 " + sp.getCoordinates());
		handleSoilid(2);
	}

	/**
	 * 揖類3#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent3(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類3#華輸 " + sp.getCoordinates());
		handleSoilid(3);
	}

	/**
	 * 揖類4#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent4(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類4#華輸 " + sp.getCoordinates());
		handleSoilid(4);
	}

	/**
	 * 揖類5#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent5(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類5#華輸 " + sp.getCoordinates());
		handleSoilid(5);
	}

	/**
	 * 揖類6#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent6(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類6#華輸 " + sp.getCoordinates());
		handleSoilid(6);
	}

	/**
	 * 揖類7#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent7(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類7#華輸 " + sp.getCoordinates());
		handleSoilid(7);
	}

	/**
	 * 揖類8#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent8(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類8#華輸 " + sp.getCoordinates());
		handleSoilid(8);
	}

	/**
	 * 揖類9#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent9(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類9#華輸 " + sp.getCoordinates());
		handleSoilid(9);
	}

	/**
	 * 揖類10#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent10(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類10#華輸 " + sp.getCoordinates());
		handleSoilid(10);
	}

	/**
	 * 揖類11#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent11(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類11#華輸 " + sp.getCoordinates());
		handleSoilid(11);
	}

	/**
	 * 揖類12#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent12(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類12#華輸 " + sp.getCoordinates());
		handleSoilid(12);
	}

	/**
	 * 揖類13#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent13(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類13#華輸 " + sp.getCoordinates());
		handleSoilid(13);
	}

	/**
	 * 揖類14#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent14(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類14#華輸 " + sp.getCoordinates());
		handleSoilid(14);
	}

	/**
	 * 揖類15#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent15(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類15#華輸 " + sp.getCoordinates());
		handleSoilid(15);
	}

	/**
	 * 揖類16#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent16(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類16#華輸 " + sp.getCoordinates());
		handleSoilid(16);
	}

	/**
	 * 揖類17#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent17(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類17#華輸 " + sp.getCoordinates());
		handleSoilid(17);
	}

	/**
	 * 揖類18#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent18(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類18#華輸 " + sp.getCoordinates());
		handleSoilid(18);
	}

	/**
	 * 揖類19#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent19(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類19#華輸 " + sp.getCoordinates());
		handleSoilid(19);
	}

	/**
	 * 揖類20#華輸
	 * 
	 * @param sp
	 * @param event
	 */
	public void onTouchEvent20(Spirit sp, MotionEvent event) {
		Log.v(TAG, "揖類20#華輸 " + sp.getCoordinates());
		handleSoilid(20);
	}

	/**
	 * 揭燴勤茼華瘍腔珛昢
	 * 
	 * @param soilid
	 *            華輸晤瘍
	 */
	private void handleSoilid(int soilid) {

		JSONArray jsonarr = new JSONArray();
		try {
			jsonarr.put(0, soilid);
			JSONObject param = new JSONObject();
			param.put("actioncode", 14);
			param.put("verifycode", AppUtil.verifycode);
			param.put("data", jsonarr);
			thread = new ActivityThread(param.toString(), "castle.php", soilid,
					14);
			thread.start();
		} catch (JSONException e) {
			e.printStackTrace();
		}
	}

	/**
	 * 粟堤睿揭燴諾璋坢勤趕遺
	 * 
	 * @param soilid
	 */
	private void handleSpaceLandTowerDialog(final int soilid) {

		LayoutInflater factory = LayoutInflater.from(this.getContext());
		View textEntryView = factory.inflate(R.layout.upgradelist, null);

		String namee[] = { "援棧馴僻倛宒ㄛ褫眕萋郘苤寞耀腔窒勦", "ぱ籵馴僻倛宒ㄛ褫眕萋郘珨隅寞耀腔華醱窒勦" };

		ListView list = (ListView) textEntryView
				.findViewById(R.id.upgradelist_listview);

		ArrayList<HashMap<String, Object>> listData = new ArrayList<HashMap<String, Object>>();

		for (int i = 0; i < 2; i++) {
			HashMap<String, Object> map = new HashMap<String, Object>();
			map.put("NAME", namee[i]);
			map.put("Upgrade", "汔撰");
			listData.add(map);
		}

		SimpleAdapter adapter = new SimpleAdapter(this.getContext(), listData,
				R.layout.upgrade02, new String[] { "NAME", "Upgrade" },
				new int[] { R.id.upgrade02_TextView01,
						R.id.upgrade02_TextView02 });
		list.setAdapter(adapter);

		AlertDialog dlg = new AlertDialog.Builder(this.getContext())
				.setTitle("璋坢蘿怢")
				.setIcon(R.drawable.land_tower_air_defense)
				.setView(textEntryView)
				.setNegativeButton(R.string.close,
						new DialogInterface.OnClickListener() {
							@Override
							public void onClick(DialogInterface dialog,
									int which) {
							}
						}).create();
		dlg.show();

		// 揖類ListView砐醴奀緊腔岈璃揭燴﹝
		list.setOnItemClickListener(new AdapterView.OnItemClickListener() {
			private String name;
			private String wood;
			private String food;
			private String ironOre;
			private String population;
			private String time;

			@Override
			public void onItemClick(AdapterView<?> parent, View view,
					int position, long id) {
				int img = 0;

				if (position == 0) {
					img = R.drawable.land_tower_ground_defense;
					name = "援棧馴僻倛宒";
					wood = "1500";
					food = "500";
					ironOre = "20";
					population = "10";
					time = "00:01:00";
				}
				if (position == 1) {
					img = R.drawable.land_tower_air_defense;
					name = "ぱ籵馴僻倛宒";
					wood = "2500";
					food = "800";
					ironOre = "30";
					population = "10";
					time = "00:01:00";
				}

				LayoutInflater factory2 = LayoutInflater.from(HolyWarScene.this
						.getContext());
				View textEntryView2 = factory2
						.inflate(R.layout.upgrade01, null);

				// dialog爵腔杅擂扢离
				TextView txtWood = (TextView) textEntryView2
						.findViewById(R.id.upgrade01_wood);
				txtWood.setText(wood);
				TextView txtFood = (TextView) textEntryView2
						.findViewById(R.id.upgrade01_food);
				txtFood.setText(food);
				TextView txtIronOre = (TextView) textEntryView2
						.findViewById(R.id.upgrade01_ironOre);
				txtIronOre.setText(ironOre);
				TextView txtPopulation = (TextView) textEntryView2
						.findViewById(R.id.upgrade01_population);
				txtPopulation.setText(population);
				TextView txtTime = (TextView) textEntryView2
						.findViewById(R.id.upgrade01_time);
				txtTime.setText(time);

				AlertDialog dlg = new AlertDialog.Builder(HolyWarScene.this
						.getContext())
						.setTitle(name)
						.setIcon(img)
						.setView(textEntryView2)
						.setPositiveButton(R.string.upgrade,
								new DialogInterface.OnClickListener() {
									@Override
									public void onClick(DialogInterface dialog,
											int which) {
										try {
											JSONArray jsonarr = new JSONArray();
											jsonarr.put(0, soilid);

											JSONObject param = new JSONObject();
											param.put("verifycode",
													AppUtil.verifycode);
											param.put("actioncode", 15);
											param.put("data", jsonarr);

											thread = new ActivityThread(param
													.toString(), "castle.php",
													soilid, 15);
											thread.start();
										} catch (JSONException e) {
											AppUtil.button1Dialog(
													HolyWarScene.this
															.getContext(),
													"杅擂換冞渣昫ㄐ");
										}
									}
								})
						.setNegativeButton(R.string.close,
								new DialogInterface.OnClickListener() {

									// @Override
									public void onClick(DialogInterface dialog,
											int which) {
									}
								}).create();
				dlg.show();

			}
		});

	}

	/**
	 * 湍衄桸條膘耟汔撰
	 * 
	 * @param jsonStr
	 * @param soilid
	 */
	private void handleRequestUpgradeRecruitSoldierInfoResult(String jsonStr,
			final int soilid) {
		try {
			String[] upgradInfo = new String[6];
			// 賤鎢JSON
			JSONObject json = new JSONObject(jsonStr.toString());

			String building_level = json.getString("building_level");
			JSONArray jsonResponse = json.getJSONArray("upgrade_info");
			upgradInfo[1] = jsonResponse.getString(0);
			upgradInfo[2] = jsonResponse.getString(1);
			upgradInfo[3] = jsonResponse.getString(2);
			upgradInfo[4] = jsonResponse.getString(3);
			upgradInfo[5] = jsonResponse.getString(4);
			upgradInfo[0] = AppUtil.getHanZname(spiritsName[soilid - 1])
					+ building_level + " 撰";

			LayoutInflater factory = LayoutInflater.from(this.getContext());
			View textEntryView = factory.inflate(R.layout.upgrade01, null);

			// dialog爵腔杅擂扢离
			TextView wood = (TextView) textEntryView
					.findViewById(R.id.upgrade01_wood);
			wood.setText(upgradInfo[1]);
			TextView food = (TextView) textEntryView
					.findViewById(R.id.upgrade01_food);
			food.setText(upgradInfo[2]);
			TextView ironOre = (TextView) textEntryView
					.findViewById(R.id.upgrade01_ironOre);
			ironOre.setText(upgradInfo[3]);
			TextView population = (TextView) textEntryView
					.findViewById(R.id.upgrade01_population);
			population.setText(upgradInfo[4]);
			TextView time = (TextView) textEntryView
					.findViewById(R.id.upgrade01_time);
			time.setText(upgradInfo[5]);

			int iconid = AppUtil.getDialogIconId(spiritsImage[soilid - 1],
					spiritsName[soilid - 1]);
			AlertDialog dlg = new AlertDialog.Builder(this.getContext())
					.setTitle(upgradInfo[0])
					.setIcon(iconid)
					.setView(textEntryView)
					.setPositiveButton(R.string.upgrade,
							new DialogInterface.OnClickListener() {

								@Override
								public void onClick(DialogInterface dialog,
										int which) {
									try {
										JSONArray jsonarr = new JSONArray();
										jsonarr.put(0, soilid);

										JSONObject param = new JSONObject();
										param.put("verifycode",
												AppUtil.verifycode);
										param.put("actioncode", 15);
										param.put("data", jsonarr);

										thread = new ActivityThread(param
												.toString(), "castle.php",
												soilid, 15);
										thread.start();
									} catch (JSONException e) {
										AppUtil.button1Dialog(
												HolyWarScene.this.getContext(),
												"杅擂換冞渣昫ㄐ");
									}
								}
							})
					.setNeutralButton(R.string.recruit_soldier,
							new DialogInterface.OnClickListener() {

								@Override
								public void onClick(DialogInterface dialog,
										int which) {
									// 覃蚚尪條桸躁勤趕遺揭燴源楊
									popupRecruitSoldierDialog(soilid);
								}
							})
					.setNegativeButton(R.string.close,
							new DialogInterface.OnClickListener() {

								@Override
								public void onClick(DialogInterface dialog,
										int which) {
								}
							}).create();
			dlg.show();
		} catch (JSONException e) {
			AppUtil.button1Dialog(this.getContext(), "杅擂換冞渣昫ㄐ");
		}
		try {
			thread.join();
		} catch (InterruptedException e) {
		}
	}

	/**
	 * ぱ籵膘耟汔撰
	 * 
	 * @param jsonStr
	 * @param soilid
	 */
	private void handleRequestUpgradeInfoResult(String jsonStr, final int soilid) {
		String[] upgradInfo = new String[6];

		try {
			// 賤鎢JSON
			JSONObject json = new JSONObject(jsonStr.toString());
			String building_level = json.getString("building_level");
			JSONArray jsonResponse = json.getJSONArray("upgrade_info");
			upgradInfo[1] = jsonResponse.getString(0);
			upgradInfo[2] = jsonResponse.getString(1);
			upgradInfo[3] = jsonResponse.getString(2);
			upgradInfo[4] = jsonResponse.getString(3);
			upgradInfo[5] = jsonResponse.getString(4);

			upgradInfo[0] = AppUtil.getHanZname(spiritsName[soilid - 1])
					+ building_level + " 撰";

			LayoutInflater factory = LayoutInflater.from(this.getContext());
			View textEntryView = factory.inflate(R.layout.upgrade01, null);

			// dialog爵腔杅擂扢离
			TextView wood = (TextView) textEntryView
					.findViewById(R.id.upgrade01_wood);
			wood.setText(upgradInfo[1]);
			TextView food = (TextView) textEntryView
					.findViewById(R.id.upgrade01_food);
			food.setText(upgradInfo[2]);
			TextView ironOre = (TextView) textEntryView
					.findViewById(R.id.upgrade01_ironOre);
			ironOre.setText(upgradInfo[3]);
			TextView population = (TextView) textEntryView
					.findViewById(R.id.upgrade01_population);
			population.setText(upgradInfo[4]);
			TextView time = (TextView) textEntryView
					.findViewById(R.id.upgrade01_time);
			time.setText(upgradInfo[5]);

			int iconid = AppUtil.getDialogIconId(spiritsImage[soilid - 1],
					spiritsName[soilid - 1]);

			AlertDialog dlg = new AlertDialog.Builder(this.getContext())
					.setTitle(upgradInfo[0])
					.setIcon(iconid)
					.setView(textEntryView)
					.setPositiveButton(R.string.upgrade,
							new DialogInterface.OnClickListener() {

								@Override
								public void onClick(DialogInterface dialog,
										int which) {
									try {
										JSONArray jsonarr = new JSONArray();
										jsonarr.put(0, soilid);

										JSONObject param = new JSONObject();
										param.put("verifycode",
												AppUtil.verifycode);
										param.put("actioncode", 15);
										param.put("data", jsonarr);

										thread = new ActivityThread(param
												.toString(), "castle.php",
												soilid, 15);
										thread.start();
									} catch (JSONException e) {
										AppUtil.button1Dialog(
												HolyWarScene.this.getContext(),
												"杅擂換冞渣昫ㄐ");
									}
								}
							})
					.setNegativeButton(R.string.close,
							new DialogInterface.OnClickListener() {

								// @Override
								public void onClick(DialogInterface dialog,
										int which) {

								}
							}).create();
			dlg.show();

		} catch (JSONException e) {
			AppUtil.button1Dialog(this.getContext(), "杅擂換冞渣昫ㄐ");
		}
		try {
			thread.join();
		} catch (InterruptedException e) {
		}
	}

	/**
	 * 
	 * 桸躁尪條勤趕遺揭燴
	 * 
	 * @param soilid
	 *            華輸晤瘍
	 */
	private void popupRecruitSoldierDialog(final int soilid) {
		// dialog條笱蹈桶
		LayoutInflater factory = LayoutInflater.from(this.getContext());
		View textEntryview1 = factory.inflate(R.layout.upgradelist, null);
		ListView listrecruit = (ListView) textEntryview1
				.findViewById(R.id.upgradelist_listview);

		int imgid = 0;
		String title = "桸躁條笱";
		String type[];
		ArrayList<HashMap<String, Object>> listData = new ArrayList<HashMap<String, Object>>();
		final String name = spiritsName[soilid - 1];
		if (name.equals("parade_ground")) {
			imgid = R.drawable.parade_ground;
			type = new String[5];
			type[0] = "堍怀條";
			type[1] = "淈舷條";
			type[2] = "鏍條";
			type[3] = "Л條";
			type[4] = "棧諦";

			for (int i = 0; i < type.length; i++) {
				HashMap<String, Object> map = new HashMap<String, Object>();
				map.put("NAME", type[i]);
				map.put("Recruit", "桸躁");
				listData.add(map);
			}
		}
		if (name.equals("archery_camp")) {
			imgid = R.drawable.archery_camp;
			type = new String[1];
			type[0] = "朸扞忒";

			for (int i = 0; i < type.length; i++) {
				HashMap<String, Object> map = new HashMap<String, Object>();
				map.put("NAME", type[i]);
				map.put("Recruit", "桸躁");
				listData.add(map);
			}
		}
		if (name.equals("voodoo")) {
			imgid = R.drawable.voodoo;
			type = new String[1];
			type[0] = "拵馮扲尪";

			for (int i = 0; i < type.length; i++) {
				HashMap<String, Object> map = new HashMap<String, Object>();
				map.put("NAME", type[i]);
				map.put("Recruit", "桸躁");
				listData.add(map);
			}
		}
		if (name.equals("martial_club")) {
			imgid = R.drawable.martial_club;
			type = new String[1];
			type[0] = "挕尪";

			for (int i = 0; i < type.length; i++) {
				HashMap<String, Object> map = new HashMap<String, Object>();
				map.put("NAME", type[i]);
				map.put("Recruit", "桸躁");
				listData.add(map);
			}
		}
		if (name.equals("cavalry_camp")) {
			imgid = R.drawable.cavalry_camp;
			type = new String[1];
			type[0] = "羭る";

			for (int i = 0; i < type.length; i++) {
				HashMap<String, Object> map = new HashMap<String, Object>();
				map.put("NAME", type[i]);
				map.put("Recruit", "桸躁");
				listData.add(map);
			}
		}
		if (name.equals("army_arsenal")) {
			imgid = R.drawable.army_arsenal;
			type = new String[2];
			type[0] = "喳袉陬";
			type[1] = "芘坒陬";

			for (int i = 0; i < type.length; i++) {
				HashMap<String, Object> map = new HashMap<String, Object>();
				map.put("NAME", type[i]);
				map.put("Recruit", "桸躁");
				listData.add(map);
			}
		}
		SimpleAdapter adapter = new SimpleAdapter(
				HolyWarScene.this.getContext(), listData, R.layout.upgrade02,
				new String[] { "NAME", "Recruit" }, new int[] {
						R.id.upgrade02_TextView01, R.id.upgrade02_TextView02 });
		listrecruit.setAdapter(adapter);
		AlertDialog dlg = new AlertDialog.Builder(
				HolyWarScene.this.getContext())
				.setTitle(title)
				.setIcon(imgid)
				.setView(textEntryview1)
				.setNegativeButton(R.string.close,
						new DialogInterface.OnClickListener() {
							@Override
							public void onClick(DialogInterface dialog,
									int which) {
							}
						}).create();
		dlg.show();

		listrecruit
				.setOnItemClickListener(new AdapterView.OnItemClickListener() {

					private int img;
					private String soldierInfo[] = new String[5];

					@Override
					public void onItemClick(AdapterView<?> parent, View view,
							int position, long id) {

						if (name.equals("parade_ground")) {
							switch (position) {
							case 0:
								img = R.drawable.transport_soldier;
								soldierInfo = AppUtil.recruitSoldierStuffInfo(
										name, "transport_soldier");
								break;
							case 1:
								img = R.drawable.scout_soldier;
								soldierInfo = AppUtil.recruitSoldierStuffInfo(
										name, "scout_soldier");
								break;
							case 2:
								img = R.drawable.militia;
								soldierInfo = AppUtil.recruitSoldierStuffInfo(
										name, "militia");
								break;
							case 3:
								img = R.drawable.spearman;
								soldierInfo = AppUtil.recruitSoldierStuffInfo(
										name, "spearman");
								break;
							case 4:
								img = R.drawable.e_assassin;
								soldierInfo = AppUtil.recruitSoldierStuffInfo(
										name, "assassin");
							}
						}
						if (name.equals("archery_camp") && position == 0) {
							img = R.drawable.marksman;
							soldierInfo = AppUtil.recruitSoldierStuffInfo(name,
									"marksman");
						}
						if (name.equals("voodoo") && position == 0) {
							img = R.drawable.voodoo_man;
							soldierInfo = AppUtil.recruitSoldierStuffInfo(name,
									"voodoo_man");
						}
						if (name.equals("martial_club") && position == 0) {
							img = R.drawable.warrior;
							soldierInfo = AppUtil.recruitSoldierStuffInfo(name,
									"warrior");
						}

						if (name.equals("cavalry_camp") && position == 0) {
							img = R.drawable.military_general;
							soldierInfo = AppUtil.recruitSoldierStuffInfo(name,
									"military_general");
						}

						if (name.equals("army_arsenal")) {
							switch (position) {
							case 0:
								img = R.drawable.battering_ram;
								soldierInfo = AppUtil.recruitSoldierStuffInfo(
										name, "battering_ram");
								break;
							case 1:
								img = R.drawable.catapult;
								soldierInfo = AppUtil.recruitSoldierStuffInfo(
										name, "catapult");
							}
						}
						// 粟堤桸躁尪條杅講勤趕遺
						popupRecruitSoldierNumberDialog(soldierInfo, img);

					}
				});
	}

	/**
	 * 籵徹桸躁尪條陓洘睿芞えㄛ粟堤桸躁尪條杅講勤趕遺
	 * 
	 * @param soldierInfo
	 *            尪條桸躁陓洘
	 * @param img
	 *            桸躁尪條芞えid
	 */
	private void popupRecruitSoldierNumberDialog(final String soldierInfo[],
			int img) {

		// TODO
	}

	/**
	 * 尪條桸躁俇傖隙覃源楊﹝
	 * 
	 * @param jsonStr
	 *            殿隙腔JSON趼睫揹
	 */
	private void handleRequestRecruitSoldierResult(String jsonStr) {
		// TODO
	}

	/**
	 * 萸僻汔撰偌聽腔隙覃揭燴﹝
	 */
	private void handleClickBuildingUpgrade(String jsonStr) {
		String backFlag = "44";
		JSONObject json;
		try {
			json = new JSONObject(jsonStr);
			if (json != null) {
				backFlag = json.getString("upgrade_back_flag");
			}
		} catch (JSONException e) {
			e.printStackTrace();
		}

		if (backFlag.equals("1")) {
			Toast.makeText(this.getContext(), "汔撰笢...", Toast.LENGTH_SHORT)
					.show();
		} else if (backFlag.equals("44")) {
			Toast.makeText(this.getContext(), "杅擂渣昫ㄐ", Toast.LENGTH_LONG)
					.show();
		} else {
			Toast.makeText(this.getContext(), "第蹋祥逋ㄛ祥夔汔撰ㄐ", Toast.LENGTH_SHORT)
					.show();
		}
	}

	class MyHandler extends Handler {

		@Override
		public void handleMessage(Message msg) {

			switch (msg.what) {
			case 0:
				if (msg.obj != null) {
					Map data = (Map) msg.obj;
					Integer soilid = (Integer) data.get("soilid");
					Integer actioncode = (Integer) data.get("actioncode");
					String jsonData = (String) data.get("jsonData");
					if (actioncode == 14) {
						String name = spiritsName[soilid - 1];
						if (name.equals("temple") || name.equals("residence")
								|| name.equals("storehouse")
								|| name.equals("chamber_secrets")
								|| name.equals("meeting_room")
								|| name.equals("demons_pavilion")
								|| name.equals("wall")
								|| name.equals("sawmill")
								|| name.equals("grain_field")
								|| name.equals("land_tower_air_defense")
								|| name.equals("land_tower_ground_defense")) {
							handleRequestUpgradeInfoResult(jsonData, soilid);
						} else if (name.equals("parade_ground")
								|| name.equals("archery_camp")
								|| name.equals("voodoo")
								|| name.equals("martial_club")
								|| name.equals("cavalry_camp")
								|| name.equals("army_arsenal")) {
							handleRequestUpgradeRecruitSoldierInfoResult(
									jsonData, soilid);
						} else if (name.equals("space_land_tower")) {
							handleSpaceLandTowerDialog(soilid);
						}
					} else if (actioncode == 15) {
						handleClickBuildingUpgrade(jsonData);
					} else if (actioncode == 16) {
						handleRequestRecruitSoldierResult(jsonData);
					}
				}
				break;
			}
			try {
				thread.join();
			} catch (InterruptedException e) {
			}
			super.handleMessage(msg);
		}
	};

	class ActivityThread extends Thread {

		/** ③⑴腔JSON趼睫揹 */
		private String jsonStr;

		/** ③⑴督昢傷褐掛恅璃 */
		private String url;

		/** 絞ヶ③⑴腔華瘍 */
		private int soilid;

		/**
		 * ③⑴雄釬 12 傑惜場宎趙 14 膘耟汔撰 15 膘耟奪燴珜醱ㄗ萸僻膘耟腔※汔撰§偌聽ㄘ 16
		 * 膘耟笢湍桸躁尪條腔ㄗ萸僻桸躁尪條腔※桸躁§偌聽ㄘ
		 */
		private int actioncode = 14;

		ActivityThread(String jsonStr, String url, int soilid, int actioncode) {
			super();
			this.jsonStr = jsonStr;
			this.url = url;
			this.soilid = soilid;
			this.actioncode = actioncode;
		}

		@Override
		public void run() {

			HttpClient httpclient = new DefaultHttpClient();
			HttpPost httppost = new HttpPost(AppUtil.URL_PREFIX + url);
			try {
				StringEntity se = new StringEntity(jsonStr);
				httppost.setEntity(se);

				HttpResponse response = httpclient.execute(httppost);
				HttpEntity entityOut = response.getEntity();

				if (entityOut != null) {
					BufferedReader br = new BufferedReader(
							new InputStreamReader(entityOut.getContent(),
									"utf-8"));
					StringBuffer sb = new StringBuffer();
					String line;
					while ((line = br.readLine()) != null) {
						sb.append(line);
					}
					Map data = new HashMap();
					data.put("soilid", soilid);
					data.put("actioncode", actioncode);
					data.put("jsonData", sb == null ? "" : sb.toString());
					Message lmsg = new Message();
					lmsg.obj = data;
					lmsg.what = 0;// 測桶傖髡
					handler.sendMessage(lmsg);
				}

			} catch (Exception e) {
				AppUtil.button1Dialog(HolyWarScene.this.getContext(), "厙釐祑都渣昫ㄐ");
				handler.sendEmptyMessage(-1);
			}

		}
	}

}
